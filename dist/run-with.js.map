{"version":3,"sources":["src/run-with.js"],"names":[],"mappings":"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","file":"dist/run-with.js","sourcesContent":["'use strict';\r\n\r\nvar child_process = require('child_process');\r\nvar tmp = require('tmp');\r\nvar fs = require('fs');\r\n\r\nfunction castError(err) {\r\n    if (err instanceof Error)\r\n        return err;\r\n    return new Error('Error ' + err);\r\n}\r\n\r\nmodule.exports = function runWith(praatExec, script, cb) {\r\n    if (!cb)\r\n        cb = function() {};\r\n    var praat;\r\n    var aborted = false;\r\n    var controller = {\r\n        abort: function() {\r\n\r\n            if (!aborted) {\r\n                if (praat) {\r\n                    praat.kill();\r\n                }\r\n            }\r\n\r\n            aborted = true;\r\n        }\r\n    };\r\n    try {\r\n        if (aborted)\r\n            throw new Error('Aborted by caller');\r\n        tmp.file({\r\n                keep: true\r\n            },\r\n            function _tempFileCreated(err, path, fd) {\r\n                try {\r\n                    var cleanupCallback = function() {\r\n                        try {\r\n                            fs.closeSync(fd);\r\n                        } catch (e) {}\r\n                        fs.unlink(path);\r\n                    };\r\n                    if (err) throw castError(err);\r\n                    if (aborted)\r\n                        throw new Error('Aborted by caller');\r\n                    fs.write(fd, script.toString(), 0, 'utf8', function(err) {\r\n                        try {\r\n                            if (err) throw castError(err);\r\n                            if (aborted)\r\n                                throw new Error('Aborted by caller');\r\n                            fs.close(fd, function(err) {\r\n                                try {\r\n                                    if (err) throw castError(err);\r\n                                    if (aborted)\r\n                                        throw new Error('Aborted by caller');\r\n                                    var stdout = '';\r\n                                    var stderr = '';\r\n                                    praat = child_process.spawn(praatExec, ['--run', path], {\r\n                                        stdio: ['ignore', 'ignore', 'ignore']\r\n                                    });\r\n                                    praat.on('close', function(err) {\r\n                                        praat = null;\r\n                                        try {\r\n                                            if (err) throw castError(err);\r\n                                            if (stderr && stderr.length > 0)\r\n                                                throw new Error(stderr.toString('utf8'));\r\n                                            if (aborted)\r\n                                                throw new Error('Aborted by caller');\r\n                                            cleanupCallback();\r\n                                            cb();\r\n                                        } catch (e) {\r\n                                            cleanupCallback();\r\n                                            cb(e);\r\n                                        }\r\n                                    });\r\n                                } catch (e) {\r\n                                    cleanupCallback();\r\n                                    cb(e);\r\n                                }\r\n                            });\r\n                        } catch (e) {\r\n                            cleanupCallback();\r\n                            cb(e);\r\n                        }\r\n                    });\r\n\r\n                    // If we don't need the file anymore we could manually call the cleanupCallback \r\n                    // But that is not necessary if we didn't pass the keep option because the library \r\n                    // will clean after itself. \r\n                } catch (e) {\r\n                    cleanupCallback();\r\n                    cb(e);\r\n                }\r\n            });\r\n    } catch (e) {\r\n        cb(e);\r\n    }\r\n    return controller;\r\n};"]}